<!DOCTYPE html>
<html>

<head>
  <title>MusicDL</title>
  <style>
    .disabled {
      visibility: hidden;
      display: none;
      pointer-events: none;
    }

    #progress-div {
      background-color: black;
      border-radius: 13px;
      padding: 3px;
    }

    #progress-done {
      background-color: orange;
      height: 20px;
      border-radius: 10px;
      width: 0%;
    }

  </style>
</head>

<body>
  <div id="query-div">
    <form id="query-form" action="">
      <label for="query-url">URL</label>
      <input id="query-url" autocomplete="off" value="https://www.youtube.com/shorts/-RE6sCKvJFU">
      <button>Continue</button>
    </form>
  </div>

  <div id="progress-div" class="disabled">
    <div id="progress-done"></div>
  </div>

  <div id="edit-div" class="disabled">
    <img alt="Video Thumbnail" id="edit-img">
    <form id="edit-form" action="">
      <label for="edit-title">Title</label>
      <input id="edit-title">
      <label for="edit-genre">Album</label>
      <input id="edit-album">
      <label for="edit-genre">Genre</label>
      <input id="edit-genre">
      <button>Download</button>
    </form>
  </div>

  <script>
    var websocket = new WebSocket('wss://' + window.location.hostname);

    queryElem = document.getElementById('query-div');
    progressElem = document.getElementById('progress-div');
    editElem = document.getElementById('edit-div');

    document.getElementById('query-form').addEventListener('submit', function (e) {
      e.preventDefault();
      input = document.getElementById('query-url');

      if (input.value) {
        websocket.send(JSON.stringify({
          command: 'download',
          url: input.value,
        }));

        queryElem.classList.add("disabled");
        progressElem.classList.remove("disabled");
      }
    });

    document.getElementById('edit-form').addEventListener('submit', function (e) {
      e.preventDefault();

      websocket.send(JSON.stringify({
        command: 'edited',
        title: document.getElementById('edit-title').value,
        album: document.getElementById('edit-album').value,
        genre: document.getElementById('edit-genre').value,
      }));

      editElem.classList.add("disabled");
      progressElem.classList.remove("disabled");
    });

    websocket.addEventListener('message', ({ data }) => {
      let event = JSON.parse(data);
      console.log(event);

      if (event['command'] == 'progress') {
        document.getElementById('progress-done').style.width = event['percentage'] + '%';
      }

      if (event['command'] == 'editor') {
        document.getElementById('edit-img').src = event['thumbnail'];
        document.getElementById('edit-title').value = event['title'];
        document.getElementById('edit-album').value = event['album'];
        document.getElementById('edit-genre').value = event['genre'];

        progressElem.classList.add("disabled");
        editElem.classList.remove("disabled");
      }

      if (event['command'] == 'finish') {
        var anchorTag = document.createElement('a');

        anchorTag.href = event['href'];
        anchorTag.download = event['download'];

        document.body.appendChild(anchorTag);
        anchorTag.click();
        document.body.removeChild(anchorTag);
      }
    });
  </script>
</body>

</html>
